@page "/"
@using MetalStorming20.Core
@rendermode InteractiveServer

<PageTitle>MetalStorm Planner</PageTitle>

<h1>MetalStorm Planner</h1>
<p class="lead">Calculate upgrade requirements and mastery rewards for your plane</p>

<div class="row g-3 mb-3">
    <div class="col-md-4">
        <label class="form-label">Current Plane Level (1-20)</label>
        <input type="number" class="form-control" @bind="currentPlaneLevel" min="1" max="20" />
    </div>
    <div class="col-md-4">
        <label class="form-label">Current Mastery Level (1-23)</label>
        <input type="number" class="form-control" @bind="currentMasteryLevel" min="1" max="23" />
    </div>
    <div class="col-md-4">
        <label class="form-label">Target Mastery Level (1-23)</label>
        <input type="number" class="form-control" @bind="targetMasteryLevel" min="1" max="23" />
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-md-6">
        <label class="form-label">Current Universal Parts</label>
        <input type="number" class="form-control" @bind="currentParts" min="0" />
    </div>
    <div class="col-md-6">
        <label class="form-label">Current Silver</label>
        <input type="number" class="form-control" @bind="currentSilver" min="0" />
    </div>
</div>

<div class="mb-4">
    <button class="btn btn-primary btn-lg" @onclick="Calculate">Calculate Requirements</button>
</div>

@if (hasCalculated)
{
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Requirements from Level @currentPlaneLevel → 20</h5>
        </div>
        <div class="card-body">
            <p><strong>Raw Need:</strong> Parts @needParts.ToString("N0"), Silver @needSilver.ToString("N0")</p>
            <p><strong>After Bank:</strong> Parts @shortPartsAfterBank.ToString("N0"), Silver @shortSilverAfterBank.ToString("N0")</p>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Future Mastery Rewards (M@(currentMasteryLevel + 1) → M@targetMasteryLevel)</h5>
        </div>
        <div class="card-body">
            <p><strong>No-Gold:</strong> Parts +@nonGoldParts.ToString("N0"), Silver +@nonGoldSilver.ToString("N0")</p>
            <p><strong>With Gold:</strong> Parts +@goldParts.ToString("N0"), Silver +@goldSilver.ToString("N0")</p>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header bg-warning">
            <h5 class="mb-0">Remaining Needed from NON-MASTERY Sources</h5>
        </div>
        <div class="card-body">
            <p><strong>No-Gold Path:</strong> Parts @shortNoGoldParts.ToString("N0"), Silver @shortNoGoldSilver.ToString("N0")</p>
            <p><strong>With Gold Path:</strong> Parts @shortGoldParts.ToString("N0"), Silver @shortGoldSilver.ToString("N0")</p>
        </div>
    </div>

    <details class="mb-3">
        <summary class="btn btn-outline-secondary">Show per-upgrade breakdown</summary>
        <table class="table table-striped mt-3">
            <thead>
                <tr>
                    <th>Upgrade</th>
                    <th>Parts</th>
                    <th>Silver</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var step in steps.Where(s => s.fromLevel >= currentPlaneLevel && s.toLevel <= 20))
                {
                    <tr>
                        <td>@step.fromLevel → @step.toLevel</td>
                        <td>@step.parts.ToString("N0")</td>
                        <td>@step.silver.ToString("N0")</td>
                    </tr>
                }
            </tbody>
        </table>
    </details>
}

@code {
    int currentPlaneLevel = 1;
    int currentMasteryLevel = 1;
    int targetMasteryLevel = 23;
    int currentParts = 0;
    int currentSilver = 0;

    bool hasCalculated;
    int needParts, needSilver;
    int shortPartsAfterBank, shortSilverAfterBank;
    int nonGoldParts, nonGoldSilver, goldParts, goldSilver;
    int shortNoGoldParts, shortNoGoldSilver, shortGoldParts, shortGoldSilver;
    IReadOnlyList<(int fromLevel, int toLevel, int parts, int silver)> steps = Array.Empty<(int, int, int, int)>();

    void Calculate()
    {
        // Clamp values to valid ranges
        targetMasteryLevel = Planner.Clamp(targetMasteryLevel, 1, 23);
        currentPlaneLevel = Planner.Clamp(currentPlaneLevel, 1, 20);
        currentMasteryLevel = Planner.Clamp(currentMasteryLevel, 1, 23);

        // Calculate requirements
        (needParts, needSilver) = Planner.NeedToLevel20(currentPlaneLevel);
        shortPartsAfterBank = Math.Max(0, needParts - currentParts);
        shortSilverAfterBank = Math.Max(0, needSilver - currentSilver);

        // Calculate mastery rewards
        (nonGoldParts, nonGoldSilver) = Planner.FutureMasteryRewards(currentMasteryLevel, targetMasteryLevel, includeGold: false);
        (goldParts, goldSilver) = Planner.FutureMasteryRewards(currentMasteryLevel, targetMasteryLevel, includeGold: true);

        // Calculate remaining needed
        shortNoGoldParts = Math.Max(0, shortPartsAfterBank - nonGoldParts);
        shortNoGoldSilver = Math.Max(0, shortSilverAfterBank - nonGoldSilver);

        shortGoldParts = Math.Max(0, shortPartsAfterBank - goldParts);
        shortGoldSilver = Math.Max(0, shortSilverAfterBank - goldSilver);

        steps = Planner.GetUpgradeSteps();
        hasCalculated = true;
    }
}
